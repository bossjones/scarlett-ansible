# file: bossjones.common/tasks/setup_scarlett_user.yml
---

- name: Create Pi Group
  group: name="{{base_vars.USER}}"
         gid=1000
         state=present

- name: Create vboxusers Group
  group: name=vboxusers
         state=present
         system=yes

- name: Create Pi User
  user: name="{{base_vars.USER}}"
        comment='Scarlett User Pi'
        shell=/bin/bash
        home="/home/{{base_vars.USER}}"
        group="{{base_vars.USER}}"
        uid=1000
        password=$6$UoXP1mRrk$S4k6yMNQkcX38ZP5OqEo7WaXm7ahly9qTEyYVDRP2kHBfh4ToShZHVcPYjKmYiGslDuiv7dmS/3.9sbZ5Z75u/
        state=present
        groups=adm,cdrom,sudo,dip,plugdev,lpadmin,sambashare,pulse,pulse-access,tty,audio,vboxusers

# NOTE: missing group dailout

- name: Create ~pi/dev and ~pi/dev/bossjones-github/scarlett_os folders
  file: path="{{virtualenv_vars.MAIN_DIR}}"
        state=directory
        mode=0755
        recurse=yes
        owner=pi
        group=pi

- name: clone scarlett_os into /home/pi/dev/bossjones-github/scarlett_os
  git: repo=https://github.com/bossjones/scarlett_os.git
       dest=/home/pi/dev/bossjones-github/scarlett_os
       update=no
       version="{{base_vars.GITHUB_BRANCH}}"
       refspec=+refs/pull/*:refs/heads/*
  become: pi
  become_user: pi


# Leaving this here because we need the folder structure in place to setup pocketsphinx
- name: Create ~pi/dev and ~pi/dev/bossjones-github/scarlett-dbus-poc folders
  file: path=/home/pi/dev/bossjones-github/scarlett-dbus-poc
        state=directory
        mode=0755
        recurse=yes
        owner=pi
        group=pi

- name: clone scarlett-dbus-poc into /home/pi/dev/bossjones-github/scarlett-dbus-poc
  git: repo=https://github.com/bossjones/scarlett-dbus-poc.git
       dest=/home/pi/dev/bossjones-github/scarlett-dbus-poc
       update=no
       version="{{base_vars.GITHUB_BRANCH}}"
       refspec=+refs/pull/*:refs/heads/*
  become: pi
  become_user: pi

- name: clone scarlett into /home/pi/dev/bossjones-github/scarlett
  git: repo=https://github.com/bossjones/scarlett.git
       dest=/home/pi/dev/bossjones-github/scarlett
       update=no
       version=master
       refspec=+refs/pull/*:refs/heads/*
  become: pi
  become_user: pi

- name: clone scarlett into /home/pi/dev/bossjones-github/scarlett_os
  git: repo=https://github.com/bossjones/scarlett_os.git
       dest=/home/pi/dev/bossjones-github/scarlett_os
       update=no
       version=master
       refspec=+refs/pull/*:refs/heads/*
  become: pi
  become_user: pi

- name: Install scarlett requirements.txt into the virtualenv scarlett_os
  shell: |
    export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3
    export WORKON_HOME={{ virtualenv_vars.VIRT_ROOT }}
    source /usr/local/bin/virtualenvwrapper.sh
    cd {{virtualenv_vars.MAIN_DIR}}
    {{ virtualenv_vars.VIRT_ROOT }}/bin/pip3 install -r {{ virtualenv_vars.MAIN_DIR }}/{{ item }}
  args:
    executable: /bin/bash
  # args:
  #   chdir: "{{virtualenv_vars.MAIN_DIR}}"
  with_items:
  - requirements.txt
  - requirements_dev.txt
  become: pi
  become_user: pi
  tags:
  - python
  - pip
  - requirements

# TODO: Make sure we downgrade path.py to v7.7.1, this is untested
# SOURCE: http://stackoverflow.com/questions/32252122/installing-ipython-importerror-cannot-import-name-path
- name: downgrade path.py to v7.7.1 in virtualenv scarlett_os
  command: "{{ virtualenv_vars.VIRT_ROOT }}/bin/pip3 install -I path.py==7.7.1"
  become: pi
  become_user: pi
  tags:
  - python
  - pip
  - requirements

# TODO: Get this installed into requirements.txt instead of here !!!!!!!!!!!!
- name: Install colorlog into the virtualenv
  command: "{{ virtualenv_vars.VIRT_ROOT }}/bin/pip3 install colorlog"
  become: pi
  become_user: pi
  tags:
  - python
  - pip
  - requirements

- name: clone scarlett-gstreamer-pocketsphinx-demo into /home/pi/dev/bossjones-github/scarlett-gstreamer-pocketsphinx-demo
  git: repo=https://github.com/bossjones/scarlett-gstreamer-pocketsphinx-demo.git
       dest=/home/pi/dev/bossjones-github/scarlett-gstreamer-pocketsphinx-demo
       update=no
       version=master
       refspec=+refs/pull/*:refs/heads/*
  become: pi
  become_user: pi

# COMMENTING THIS OUT FOR NOW- name: Install scarlett requirements.txt into the virtualenv scarlett-dbus-poc pip3
# COMMENTING THIS OUT FOR NOW  pip: requirements=/home/pi/dev/bossjones-github/scarlett/{{ item }}
# COMMENTING THIS OUT FOR NOW       virtualenv=/home/pi/.virtualenvs/scarlett-dbus-poc
# COMMENTING THIS OUT FOR NOW       executable=/usr/local/bin/pip3
# COMMENTING THIS OUT FOR NOW  with_items:
# COMMENTING THIS OUT FOR NOW  - requirements.txt
# COMMENTING THIS OUT FOR NOW  - requirements_plugins.txt
# COMMENTING THIS OUT FOR NOW  - requirements_dev.txt
# COMMENTING THIS OUT FOR NOW  become: pi
# COMMENTING THIS OUT FOR NOW  become_user: pi
# COMMENTING THIS OUT FOR NOW  tags:
# COMMENTING THIS OUT FOR NOW  - python
# COMMENTING THIS OUT FOR NOW  - pip
# COMMENTING THIS OUT FOR NOW  - requirements

# TODO: Make sure we downgrade path.py to v7.7.1, this is untested
# SOURCE: http://stackoverflow.com/questions/32252122/installing-ipython-importerror-cannot-import-name-path
# COMMENTING THIS OUT FOR NOW # - name: Install scarlett requirements.txt into the virtualenv scarlett-dbus-poc
# COMMENTING THIS OUT FOR NOW #   pip: name=path.py version=7.7.1
# COMMENTING THIS OUT FOR NOW #        virtualenv=/home/pi/.virtualenvs/scarlett-dbus-poc
# COMMENTING THIS OUT FOR NOW #        extra_args='-I'
# COMMENTING THIS OUT FOR NOW #        executable=/usr/local/bin/pip3
# COMMENTING THIS OUT FOR NOW #   become: pi
# COMMENTING THIS OUT FOR NOW #   become_user: pi
# COMMENTING THIS OUT FOR NOW #   tags:
# COMMENTING THIS OUT FOR NOW #   - python
# COMMENTING THIS OUT FOR NOW #   - pip
# COMMENTING THIS OUT FOR NOW #   - requirements
# COMMENTING THIS OUT FOR NOW #
# COMMENTING THIS OUT FOR NOW # # TODO: Get this installed into requirements.txt instead of here !!!!!!!!!!!!
# COMMENTING THIS OUT FOR NOW # - name: Install colorlog into the virtualenv
# COMMENTING THIS OUT FOR NOW #   pip: name=colorlog
# COMMENTING THIS OUT FOR NOW #        virtualenv=/home/pi/.virtualenvs/scarlett-dbus-poc
# COMMENTING THIS OUT FOR NOW #        executable=/usr/local/bin/pip3
# COMMENTING THIS OUT FOR NOW #   become: pi
# COMMENTING THIS OUT FOR NOW #   become_user: pi
# COMMENTING THIS OUT FOR NOW #   tags:
# COMMENTING THIS OUT FOR NOW #   - python
# COMMENTING THIS OUT FOR NOW #   - pip
# COMMENTING THIS OUT FOR NOW #   - requirements
